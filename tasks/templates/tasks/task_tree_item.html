
<li class="task-item">
    <div class="task-header">
        <a href="{% url 'edit_task' task.pk %}">
            {{ task.name }}
            <i class="fas fa-edit" title="Редактировать"></i>
        </a>
        <button class="view-details" data-task-id="{{ task.pk }}">
            <i class="fas fa-eye" title="Показать детали"></i>
        </button>
        {% if task.subtasks.exists %}
            <button class="toggle-subtasks" data-task-id="{{ task.pk }}" data-count="{{ task.subtasks.count }}">
                ещё {{ task.subtasks.count }}
            </button>
        {% endif %}
    </div>
    {% comment %} <p>Задача на: {{ task.task_planned_effort }} | (подзадачи на: {{ task.subtask_planned_effort }})</p> {% endcomment %}
    
    <div class="task-status">
        {% if task.status != 'completed' %}
        <form class="status-form" data-task-id="{{ task.pk }}" method="post" action="{% url 'update_task_status' task.pk %}">
            {% csrf_token %}
            <label for="status-select-{{ task.pk }}" class="status-label">
                Текущий статус: 
            </label>
            <select id="status-select-{{ task.pk }}" name="status" class="status-select">
                {% for status, status_display in task.STATUS_CHOICES %}
                    <option value="{{ status }}" {% if status == task.status %}selected{% endif %}>
                        {{ status_display }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit">Обновить статус</button>
            <div class="status-message" id="status-message-{{ task.pk }}"></div>
        </form>
        {% else %}
            <span>Задача завершена.</span>
        {% endif %}
    </div>

    {% comment %} {% if task.status == 'completed' %}
        <p>Была выполнена за: {{ task.total_actual_effort }}</p>
    {% endif %}

    <a href="{% url 'create_subtask' task.pk %}">Создать подзадачу</a> {% endcomment %}
    {% comment %} {% if not task.subtasks.exists %}
        <a class="delete-link" href="{% url 'delete_task' task.pk %}">Удалить</a>
    {% else %}
        <span class="note">* удалить нельзя, есть подзадачи</span>
    {% endif %} {% endcomment %}

    {% include "tasks/task_subtasks.html" with task=task %}
</li>

<script>
    $(document).ready(function() {
        // Обработка клика по кнопке с глазом для отображения деталей задачи
        $('.view-details').on('click', function() {
            var taskId = $(this).data('task-id');
    
            $.ajax({
                url: "{% url 'task_details' 0 %}".replace('/0/', '/' + taskId + '/'), 
                method: 'GET',
                success: function(data) {
                    var detailsHtml = `
                        <h3>${data.name}</h3>
                        <p><strong>Описание:</strong> ${data.description}</p>
                        <p><strong>Исполнители:</strong> ${data.performers}</p>
                        <p><strong>Статус:</strong> ${data.status}</p>
                        <p><strong>Плановая трудоёмкость:</strong> ${data.planned_effort}</p>
                        <p><strong>Фактическое время выполнения:</strong> ${data.actual_effort}</p>
                        <p><strong>Дата создания:</strong> ${data.created_at}</p>
                        <p><strong>Дата завершения:</strong> ${data.completed_at}</p>
                    `;
    
                    if (data.is_terminal) {
                        detailsHtml += `<a href="/tasks/${taskId}/delete/">Удалить задачу</a>`;
                    } else {
                        detailsHtml += `<p>Нельзя удалить, есть подзадачи</p>`;
                    }
    
                    $('#details').html(detailsHtml);
                },
                error: function() {
                    $('#details').html('<p>Ошибка загрузки данных.</p>');
                }
            });
        });
    });
</script>