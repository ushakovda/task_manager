{% extends "base.html" %}

{% load custom_filters %}

{% block header %}
    <title>Список задач</title>
{% endblock %}

{% block content %}
    <h2>Список задач</h2>
    <ul id="task-tree">
        {% for task in tasks %}
            {% if not task.parent %}
                {% include "tasks/task_tree_item.html" with task=task %}
            {% endif %}
        {% endfor %}
    </ul>
    <a href="{% url 'create_task' %}">Создать новую задачу</a>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Добавляем функциональность для скрытия/показа подзадач
        document.querySelectorAll('.toggle-subtasks').forEach(function(button) {
            button.addEventListener('click', function() {
                const taskId = button.getAttribute('data-task-id');
                const subtasks = document.getElementById('subtasks-' + taskId);
                if (subtasks.style.display === 'none') {
                    subtasks.style.display = 'block';
                    button.textContent = 'Скрыть подзадачи';
                } else {
                    subtasks.style.display = 'none';
                    button.textContent = button.getAttribute('data-count') + ' подзадачи(ей)';
                }
            });
        });

        // Обработка обновления статуса задачи
        document.querySelectorAll('.status-form').forEach(function(form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(form);
                const taskId = form.getAttribute('data-task-id');
                const statusMessageDiv = document.getElementById('status-message-' + taskId);
                const statusSelect = document.getElementById('status-select-' + taskId);
    
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusMessageDiv.textContent = data.message;
                        statusMessageDiv.style.color = 'green';
    
                        // Если статус завершен, скрываем форму
                        if (data.new_status === 'completed') {
                            form.style.display = 'none';
                            statusMessageDiv.textContent = 'Задача завершена.';
                        }
                    } else {
                        statusMessageDiv.textContent = data.message;
                        statusMessageDiv.style.color = 'red';
                        // Обновляем статус в выпадающем списке на текущий, если ошибка
                        statusSelect.value = statusSelect.querySelector('option[selected]').value;
                    }
    
                    // Скрываем сообщение через 3.5 секунды
                    setTimeout(() => {
                        statusMessageDiv.textContent = '';
                    }, 3500);
                })
                .catch(error => {
                    statusMessageDiv.textContent = 'Произошла ошибка.';
                    statusMessageDiv.style.color = 'red';
                });
            });
        });
    });
</script>
{% endblock %}